<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="Special recordings by Parakaleo Christian Ministries" />
    <meta name="author" content="Parakaleo Christian Ministries" />
    <title>Special Recordings · Parakaleo</title>

    <!-- Bootstrap core CSS -->
    <link href="../vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet" />

    <!-- Custom fonts for this template -->
    <link href="../vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css" />
    <link href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css" />
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css" />

    <!-- Custom styles for this template -->
    <link href="../css/clean-blog.min.css" rel="stylesheet" />

    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
    <script src="../js/dev.js"></script>
  </head>
  <body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
      <div class="container">
        <a class="navbar-brand" href="../index.html">Parakaleo Christian Ministries</a>
        <button class="navbar-toggler navbar-toggler-right collapsed" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
          Menu
          <i class="fa fa-bars"></i>
        </button>
        <div class="navbar-collapse collapse" id="navbarResponsive">
          <ul class="navbar-nav ml-auto">
            <li class="nav-item">
              <a class="nav-link" href="../index.html">Home</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="../about.html">About</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="../news.html">News</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="../resources.html">Resources</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="../contact.html">Contact</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="../donate.html">DONATE</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Page Header -->
    <header class="masthead" style="background-color: #8c5a20; opacity: 0.95;">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-md-10 mx-auto">
            <div class="page-heading" style="padding-top: 100px; padding-bottom: 70px;">
              <h1 style="font-size: 45px;">Special Recordings</h1>
              <!-- <span class="subheading text-white">Special recordings by Parakaleo Christian Ministries</span> -->
            </div>
          </div>
        </div>
      </div>
    </header>

    <div class="container" style="padding-top: 2rem; padding-bottom: 3rem;">
      <div class="row">
        <div class="col-lg-3 col-md-3" style="padding-bottom: 3rem;">
          <div id="podcastAccordion" data-class="podcasts-accordion">
            <!-- Podcast series accordions will be generated here -->
          </div>
        </div>

        <div class="col-lg-9 col-md-9">
          <div class="container readable d-none" data-class="error-wrap">
            <div class="alert alert-danger" role="alert">
              <strong>Error</strong>
              <span data-class="error-msg"></span>
            </div>
          </div>

          <div class="container readable">
            <h2 data-class="title"></h2>
            <h5 data-class="session"></h5>
          </div>

          <div class="container readable" style="padding: 0;">
            <audio id="player" data-class="audiosrc"></audio>
          </div>

          <div id="content" class="container readable"></div>
        </div>
      </div>
    </div>

    <style>
      .readable {
        font-size: 18px;
        line-height: 1.6;
        color: #333;
        max-width: 700px;
        margin: 0 auto;
        padding: 20px;
        text-align: left;
        background-color: #fafafa;
        word-wrap: break-word;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border-radius: 5px;
        margin-bottom: 1em;
      }

      .podcast-series {
        margin-bottom: 10px;
      }

      .podcast-series-header {
        background-color: #f8f9fa;
        padding: 10px 15px;
        border-radius: 4px;
        cursor: pointer;
        border: 1px solid #dee2e6;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .podcast-series-header.active {
        background-color: #e9ecef;
      }

      .podcast-episodes {
        padding-left: 0;
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.5s ease-out;
      }

      .podcast-episodes.show {
        max-height: 1000px;
      }

      .episode-item {
        padding: 8px 15px 8px 25px;
        border-bottom: 1px solid #f0f0f0;
        list-style-type: none;
        font-size: 14px;
        font-weight: 800;
        letter-spacing: 1px;
        text-transform: uppercase;
        border-radius: 0;
        font-family: 'Open Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif;
      }

      .episode-item.active {
        background-color: #f0f8ff;
      }
    </style>

    <script>
      const RSS_FEEDS = [
        {
          url: 'https://anchor.fm/s/10bc23fd8/podcast/rss',
          transcriptPath: '/documents/special-pod/',
        },
      ];

      const allPodcastData = {};

      const onError = (error) => {
        $('[data-class="error-wrap"]').removeClass('d-none');
        $('[data-class="error-msg"]').text(error.message);
      };

      addEventListener('DOMContentLoaded', () => init());

      async function init() {
        try {
          await Promise.all(RSS_FEEDS.map((feed) => fetchPodcastRSS(feed)));
          buildAccordionUI();
          loadEpisodeFromURL();
        } catch (error) {
          onError(error);
        }
      }

      async function fetchPodcastRSS(feed) {
        try {
          const response = await fetch(feed.url);
          if (!response.ok) {
            throw new Error(`Failed to fetch RSS feed ${feed.url}`);
          }

          const rssText = await response.text();
          const parser = new DOMParser();
          const rssDoc = parser.parseFromString(rssText, 'application/xml');

          const channelTitle = rssDoc.querySelector('channel > title')?.textContent || 'Untitled Podcast';
          const episodes = rssDoc.querySelectorAll('item');

          const episodeData = Array.from(episodes).map((episode) => ({
            podcastId: feed.url,
            podcastTitle: channelTitle,
            transcriptPath: feed.transcriptPath,
            guid: episode.querySelector('guid')?.textContent,
            title: episode.querySelector('title')?.textContent,
            pubDate: episode.querySelector('pubDate')?.textContent,
            link: episode.querySelector('link')?.textContent,
            audioUrl: episode.querySelector('enclosure')?.getAttribute('url'),
            description: episode.querySelector('description')?.textContent,
          }));

          allPodcastData[feed.url] = {
            title: channelTitle,
            episodes: episodeData,
            hidden: feed.hidden,
          };
        } catch (error) {
          console.error(`Error loading podcast ${feed.url}:`, error);
          onError(error);
        }
      }

      function buildAccordionUI() {
        const accordion = $('[data-class="podcasts-accordion"]');
        accordion.empty();

        RSS_FEEDS.forEach((feed) => {
          if (!allPodcastData[feed.url]) return;

          const podcastData = allPodcastData[feed.url];

          const accordionItem = $(`
            <div class="podcast-series ${feed.hidden ? 'd-none' : ''}" data-podcast-id="${feed.url}">
              <div class="podcast-series-header" data-toggle="collapse">
                <!--
                <strong>${podcastData.title.split(':')[0]}</strong>
                -->
                <strong>Special Recordings</strong>
                <i class="fa fa-chevron-down float-right" style="font-size: 12px;"></i>
              </div>
              <ul class="podcast-episodes">
                ${podcastData.episodes
                  .map(
                    (episode) => `
                  <a href="?id=${episode.guid}">
                    <li class="episode-item text-ellipsis" data-podcast-id="${feed.url}" data-episode-guid="${episode.guid}">
                      ${episode.title?.split(':')[0] || 'Untitled'}
                    </li>
                  </a>
                `,
                  )
                  .join('')}
              </ul>
            </div>
          `);

          accordion.append(accordionItem);
        });

        $('.podcast-series-header').click(function () {
          const isActive = $(this).hasClass('active');
          $('.podcast-series-header').removeClass('active');
          $('.podcast-episodes').removeClass('show');

          if (!isActive) {
            $(this).addClass('active');
            $(this).next('.podcast-episodes').addClass('show');
          }
        });

        $('.podcast-episodes a').click(function (e) {
          e.preventDefault();

          $('.episode-item').removeClass('active');
          $(this).find('.episode-item').addClass('active');

          const podcastId = $(this).find('.episode-item').data('podcast-id');
          const episodeGuid = $(this).find('.episode-item').data('episode-guid');

          const url = new URL(window.location);
          url.searchParams.set('id', episodeGuid);
          window.history.pushState({}, '', url);

          loadEpisode(podcastId, episodeGuid);
        });

        $(`<style class="accordion-styles">
          .podcast-series-header i.fa {
            transition: transform 0.3s;
          }
          .podcast-series-header.active i.fa {
            transform: rotate(180deg);
          }
          .text-ellipsis {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: normal;
          }
          ul.typography li {
            margin: 10px 0px;
          }
          a.obvious {
            color: #007bff;
          }
        </style>`).appendTo('head');
      }

      function loadEpisodeFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        const episodeGuid = urlParams.get('id');

        if (episodeGuid) {
          let foundPodcastId = null;

          for (const podcastId in allPodcastData) {
            const podcast = allPodcastData[podcastId];
            const episodeExists = podcast.episodes.some((ep) => ep.guid === episodeGuid);

            if (episodeExists) {
              foundPodcastId = podcastId;
              break;
            }
          }

          if (foundPodcastId) {
            $('.podcast-series-header').removeClass('active');
            $('.podcast-episodes').removeClass('show');

            $(`.podcast-series[data-podcast-id="${foundPodcastId}"] .podcast-series-header`).addClass('active');
            $(`.podcast-series[data-podcast-id="${foundPodcastId}"] .podcast-episodes`).addClass('show');

            $(`.episode-item[data-podcast-id="${foundPodcastId}"][data-episode-guid="${episodeGuid}"]`).addClass('active');

            loadEpisode(foundPodcastId, episodeGuid);
          }
        } else {
          const firstPodcastId = RSS_FEEDS[0].url;

          if (allPodcastData[firstPodcastId]) {
            const firstEpisodeGuid = allPodcastData[firstPodcastId].episodes[0]?.guid;

            if (firstEpisodeGuid) {
              $('.podcast-series-header').removeClass('active');
              $('.podcast-episodes').removeClass('show');

              $(`.podcast-series[data-podcast-id="${firstPodcastId}"] .podcast-series-header`).addClass('active');
              $(`.podcast-series[data-podcast-id="${firstPodcastId}"] .podcast-episodes`).addClass('show');

              $(`.episode-item[data-podcast-id="${firstPodcastId}"][data-episode-guid="${firstEpisodeGuid}"]`).addClass('active');

              loadEpisode(firstPodcastId, firstEpisodeGuid);
            }
          }
        }
      }

      function loadEpisode(podcastId, episodeGuid) {
        if (!allPodcastData[podcastId]) return;

        const podcast = allPodcastData[podcastId];
        const episode = podcast.episodes.find((ep) => ep.guid === episodeGuid);

        if (!episode) return;

        $('[data-class="title"]').text(episode.title || 'Untitled Episode');

        const date = episode.pubDate ? new Date(episode.pubDate) : null;
        const formattedDate = date
          ? date.toLocaleString(navigator?.language || 'en-US', {
              weekday: 'long',
              year: 'numeric',
              month: 'long',
              day: 'numeric',
            })
          : '';

        $('[data-class="session"]').text(formattedDate);
        $('[data-class="audiosrc"]').attr('src', episode.audioUrl || '');

        fetchAndRenderMarkdown(`${episode.transcriptPath}${episode.guid}.md`);

        const player = new Plyr('#player', {
          controls: ['play', 'progress', 'current-time', 'mute', 'volume', 'settings'],
          settings: ['speed'],
          speed: {
            options: [0.75, 0.9, 1, 1.1, 1.25, 1.5],
          },
        });
      }

      async function fetchAndRenderMarkdown(url) {
        try {
          const response = await fetch(url);
          if (!response.ok) {
            const fileName = url.split('/').pop();
            console.log(`Missing transcript ${fileName}`);
            throw new Error(`Missing transcript ${fileName}`);
          }

          const markdownText = await response.text();
          const renderedHTML = marked.parse(markdownText);
          $('#content').html(renderedHTML);
        } catch (error) {
          $('#content').text('The transcript is not yet available.');
        }
      }
    </script>

    <hr />
    <!-- Footer -->
    <footer>
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-md-10 mx-auto">
            <ul class="list-inline text-center">
              <li class="list-inline-item">
                <a href="../index.html">Home</a>
              </li>
              <li class="footer-menu-divider list-inline-item">⋅</li>
              <li class="list-inline-item">
                <a href="../about.html">About</a>
              </li>
              <li class="footer-menu-divider list-inline-item">⋅</li>
              <li class="list-inline-item">
                <a href="../news.html">News</a>
              </li>
              <li class="footer-menu-divider list-inline-item">⋅</li>
              <li class="list-inline-item">
                <a href="../resources.html">Resources</a>
              </li>
              <li class="footer-menu-divider list-inline-item">⋅</li>
              <li class="list-inline-item">
                <a href="../contact.html">Contact</a>
              </li>
              <li class="footer-menu-divider list-inline-item">⋅</li>
              <li class="list-inline-item">
                <a href="../donate.html">Donate</a>
              </li>
            </ul>
            <p class="copyright text-muted">
              Copyright © Steve and Erica Lawry.
            </p>
          </div>
        </div>
      </div>
    </footer>

    <!-- Bootstrap core JavaScript -->
    <script src="../vendor/jquery/jquery.min.js"></script>
    <script src="../vendor/popper/popper.min.js"></script>
    <script src="../vendor/bootstrap/js/bootstrap.min.js"></script>

    <!-- Custom scripts for this template -->
    <script src="../js/clean-blog.min.js"></script>
  </body>
</html>
